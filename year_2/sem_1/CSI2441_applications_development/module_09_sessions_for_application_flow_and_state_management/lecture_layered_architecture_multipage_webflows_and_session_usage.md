# Layered architecture, multi-page webflows and session usage

## Objectives

- Overview of sessions from ASP.net perspective
- Understand layers of a web application
	- Model
	- View
	- Controller
- Manage routing of a webflow
- Understand role of HTTP request and response in a web form
- Maintain user sessions
- Apply data transfer and facade
- Discuss more advanced uses of sessions in web applications

## State management in web applications

- State management is different in web apps to desktop app environments

### Desktop app environment

- When developing an application that runs entirely on a single machine
	- Variables are defined and values stored in local memory of that machine
	- Typically it is one user on one machine using one instance of the software
	- State of software stays consistent
		- In local memory
		- Data on screen being the item that changes the most
	- Until explicitly removed
		- Variables stay in memory
		- Items stay on screen

### Web app environment

- In web applications
	- Code that creates the interface and interacts with data sources reside on server
		- Client user sits on client side machine
	- Any interaction with application by user requires web application to reload
		- To create on-screen pages again according to instructions/events
	- Any on screen settings of the previous screen will be lost
		- Unless values can be specifically stored and then recalled
	- Because a web app might have tens, hundreds or thousands of users online at once
		- Server must be able to identify which user is currently in what particular state of interaction with the web app

## Sessions

- Sessions are typically random 32 char alphanumeric values generated by the server side scripting language
	- In conjunction with web browser client
- Each open browser window can have its own unique session value
	- If connected to the same server
- You might be performing different tasks in each browser window
	- Reading email
	- Reading news
	- Online shopping
- Though the incoming HTTP data stream comes in on a single pipe
	- The session data attached to the incoming packets can direct the correct HTML data to the correct browser window to render to the screen

![sessions](http://snag.gy/mQNA5.jpg)

## Softare architecture

### Model View Controller (MVC) architecture

![mvc](http://snag.gy/uikej.jpg)

#### MVC roles

- Model
	- The underlying data
- View
	- What's presented to the user
- Controller
	- The handling component that manages user interaction
	- Triggers appropriate updates to the model
- Web application context
	- Multiple views will be different clients with separate browsers looking at the same application in different ways

### Web Application architecture

- A .NET web application uses
	- WebForms for the view
	- Event handlers as the controller

![web application](http://snag.gy/6ebYy.jpg)

## Building a simple webflow

- We will create a simple multi-form webflow from one of our insurance system use cases
	- A customer lodging an insurance claim
- Two separate web forms for data collection
	- Policy number/type
	- Claim amount and description

![insurance views](http://snag.gy/fMUaz.jpg)

### Linking pages in a webflow

- At the moment, each form posts back to itself
- We can change this behavior by using the `Server.Transfer` method in an event handler

``` asp
Server.Transfer("webform.aspx")
```

- In this example, we transfer to `ClaimForm2.aspx` in the button event handler for `ClaimForm1.aspx`

``` asp
Server.Transfer("ClaimForm2.aspx")
```

### Final page in the webflow

- We will also add a final page to acknowledge receipt of the claim
	- `ClaimForm3.aspx`
- The event handler for `ClaimForm2.aspx` will transfer to this page

``` asp
Server.Transfer("ClaimForm3.aspx")
```

### Request parameters

- The second boolean parameter to the `Transfer` method ensures that request data is maintained if set to `true`

``` asp
Server.Transfer("ClaimForm2.aspx", true)
```

![request param](http://snag.gy/62wf2.jpg)

### Redirecting

- Instead of transferring to another page
	- We can redirect
- Redirecting creates a new request to the page so it is not possible to maintain request paramters using this method

``` asp
Response.Redirect("ClaimForm2.aspx")
```

### Page event handlers

- The **Page Load** event occurs when the web page is first loaded
- Can be used to write dynamic content to the page when it is first displayed
- We will use the Page Load event handler to display the user's policy number and policy type
	- From `ClaimForm1` on `ClaimForm2`

### Labels on `ClaimForm2`

- These labels will be populated by the Page Load event in `ClaimForm2`
	- `Policy`
	- `Type`

``` asp
<p>Your policy number: <strong>
<asp:Label ID="Policy" runat="server" Text=""></asp:Label>
</strong>
<br/>
Your policy type: <strong>
<asp:Label ID="Type" runat="server" Text=""></asp:Label>
</strong>
</p>
```

### C# and VB page event handlers

- In C#, the page event handler is automatically provided
- In VB, you need to select `(Page Events)` from the list on the top left
	- Then select the `Load` event from the list on the right

![vb page event handlers](http://snag.gy/UWwFi.jpg)

### Retrieving request parameters

- In the page load event handler we need to
	- Retrieve the request parameter
	- Populate the labels
- In VB, use the `Request.Item` method:

``` asp
Policy.Text = Request.Item("PolicyNumber")
Type.Text = Request.Item("PolicyType")
```

- In C#, use this array-like syntax:

``` cs
Policy.Text = Request["PolicyNumber"];
Type.Text = Request["PolicyType"];
```

### Webflow with request parameters

- The data from the first page is displayed when the second form loads
- A vast majority of web apps rely on multipage logic and flows to achieve business processes

![webflow with request params](http://snag.gy/imLij.jpg)

### Processing form data in the controller layer

- There are one or two processes that may take place in the controller layer
	- Data conversion
	- Validation
- Since all parameters are returned from the `Request` object as `string`s
	- We sometimes need to perform conversion processes to change these `string`s into more suitable data types

``` cs
double valueOfClaim = 0.0;
try {
	valueOfClaim = Double.parseDouble(claimValue);
} catch(NumberFormatException e) {
	e.printStackTrace();
}
```

### Insurance claim webflow

- The initial request goes to `ClaimForm1.aspx`
- The first response is simply the page generated by the web form
- The next request is also to `ClaimForm1.aspx`
- After that, the button event handler transfers between pages
- This type of webflow requires some session management

![insurance claim webflow](http://snag.gy/xGALK.jpg)

## `Session`

- HTTP is a stateless protocol
	- Does not maintain connection after a request/response cycle
- We need to store client session state on the server
- Use the `Session` object in event handlers
- A session is effectively a conversation between client/server
	- Includes multiple request/response cycles
- A session could be
	- Shopping processes at an online store
	- Series of interactions with share trading system
	- Any application where client needs to maintain some state over a series of different web pages

### `Session`s

- A session can be used to maintain client form data over a series of pages in a webflow
- Essentially, it is a distributed variable

![sessions](http://snag.gy/psjgk.jpg)

### The `Session` object

- A `Session` object is basically like a hash table
	- It can contain a collection of key/value pairs
	- Keys
		- Strings
	- Values
		- Objects
- Similar to the way data is stored in the `Request` object
- A `Session` object will be created for a client automatically when it is accessed by an event handler
- It can also be useful to use the unique session id as an identifier for records stored on a database
	- ie. Items in a shopping cart

### Setting `Session` attributes

- In VB
	- Set the items in a session using the `Item` method
		- To set an item, assign a value to a `String` key:

``` asp
Session.Item("PolicyNumber") = PolicyNumber.Text
Session.Item("PolicyType") = PolicyType.Text
```

- C# uses the same array-like syntax used with the request

``` cs
Session["PolicyNumber"] = PolicyNumber.Text;
Session["PolicyType"] = PolicyType.Text;
```

### Getting `Session` attributes

- In VB
	- Get the items in a session using the `Item` method
	- Pass the key as parameter

``` asp
Policy.Text = Session.Item("PolicyNumber")
```

- C# again uses array-like syntax
	- Type casting is required on the object returned from the session:

``` cs
Policy.Text = (string) Session["PolicyNumber"];
```

### `Session` management

- One important aspect of session management is freeing up resources that are no longer required

``` asp
Session.Abandon()
```

- At the beginning of a webflow we may want to check if the session that we have acquired from the request is new
- We can send the client back to start the webflow from the beginning by forwarding or redirecting
- VB:

``` asp
if Session.IsNewSession() then
	Response.Redirect("ClaimForm1.aspx")
end if
```

- C#:

``` cs
if(Session.IsNewSession) {
	Response.Redirect("ClaimForm1.aspx")
}
```

### Other `Session` methods

- Getting the value of a `Session` item leaves the item in the session
	- While abandoning `Session` destroys it completely
- Sometimes we need to actually remove an individual item from the session

``` asp
Session.Remove("itemKey")
```

- Similarly we can remove all the keys/values from the session
	- Both examples below have the same effect

``` asp
Session.RemoveAll()
Session.Clear()
```

- These methods empty the session but do not abandon it

## `Session` for user management

- In previous examples
	- Sessions used to store/keep a number of values
- In any system that requires users to log in
	- Sessions can be used to give them access to members only areas of web app/site
- Details stored on login and follow user around the site
	- Name
	- UserID
	- Access level
- Records of what the user does and where they go in the site can also be recorded

### `Session` for security

- The first line of security in web apps that use sessions is
	- Check if a session exists before any information is shown
- If no session exists for a client trying to load page
	- That user can be automatically redirected to the login page
- In ASP.net, login controls can be used to manage this automatically
	- Including user level management
- For novice developers
	- Session and multi level user management can be frustrating at first
- Sessions are often used to store record id values for a logged in user
- Instead of value being passed as a hidden form field or part of URL
	- It can be stored in the session where only the application can see it
- That record id can then be used on every page where information about the user is required
	- With the record id being used to query the user database
- It is a trade-off between
	- Extracting data during login
		- Having several sessions running at once
		- With all necessary user data in them
	- Single session
		- More calls to database

### Logging users

- Because of stateless nature of web
	- It can be difficult to track users once they are in a site
- Using sessions
	- We can assign each person within a website a session id
		- As they move around the site
			- We can record this session and the details about it
- Example
	- Web page name
	- Time of visit
	- Time spent on page
	- Items looked at within page
		- ie. Products
- Logging users for statistical purposes can be referred to as
	- Clickstream
	- Clickstreaming
- Different between web server logs and Clickstream data
	- Clickstream  allows site operators to follow anonymous user
		- From entry point to exit
	- Web server logs record large amounts of info that go into linear text files
	- Clickstream data is much more specific
		- Goes directly into a database for rapid manipulation
- A busy site could generate large data files
	- Requires a lot of concurrent sessions

## Clickstreaming

- Why record clickstream data
	- Help optimize navigation
	- Put items / products that people look at most often
		- Closer to most common entry point
	- See which pages people are spending the most time on
	- Cookie can be left on client machine
		- Clickstream data for visitor stored in database as profile
		- When user returns, if cookie on client still exists
			- Profile extracted
			- Products relevant to previous browsing history placed first in any search result
- Many large commercial sites make heavy use of clickstream data for client profiling

### Clickstreaming in online education

- Clickstream can be used to profile student usage of course materials
	- What items have been looked at / downloaded
	- For how long
	- Have bulletin board entries been made
	- Quiz scores / time spent on quizes
	- Log in/outs
- Can be useful for staff to see which materials are/not being utilized
- To see how students are performing in ongoing quizzes based on learning materials

### Clickstream analysis

- Collecting clickstream data is only part of process
- To understand implications of what data is saying
	- Advanced statistical analysis is required
	- Look for complex result from simple data
- Tools available online to integrate with web apps
	- Automatically track clickstream of users
	- Can export according to requirements of site admins
		- Charts
		- Graphs
		- Calculations

## Auditing

- Auditing relates to registered users within web app
- Things can be recorded as part of audit log
	- Successful logins
	- Failed logins
	- User details
	- Time
	- IP address
	- Events
		- Add
		- Edit
		- Delete
	- Logouts

### Logins

- It is critical to know when a user logs in
	- Know which user is responsible for event
- IP address
	- Where that person logged in from can be useful
	- Backtrack cases of stolen/fraudulent account details
- How often a person logs in and at what times
	- Can be useful
	- Does it vary
	- Does it vary from the norm

### Failed logins

- Instances of failed logins need to be recorded in order to detect unauthorized attempts at system access
	- Time and IP address required
- Username and password entered on each attempt need to be recorded
- Raises two issues
	- Do you limit attempts
		- From same username
		- From same IP address
		- How long do you lock user out
	- Do you allow concurrent connections with same account details
		- If a user is logged in
			- They should not be able to log in again
			- Especially from another IP address
		- Causes repudiation issues

### Event logging

- Event logging is critical when data being manipulated from database
- System should record user responsible for events and when
	- Added/deleted/edited
	- Manipulated data
	- Time of occurrence
- Challenge with data logging is how much/little information to record
- In previous example we have enough info to see
	- Who added a record
	- That it was a record addition
	- Who the new user was
		- To the point we could locate rest of details as needed
	- What time the record was added
- We can sort for events according to any of these data points
- Remember
	- Web app could have tens, hundred, thousands of users per day
	- Such activity could lead to unmanageable log table sizes and server activity
- Greater the fidelity of logging environment
	- The greater the load on the system
	- Reduced application performance
- Point of logging is to provide admins with enough info to discover who did what to which data and when
- Sessions are used to clickstream anonymous users within a system
	- While database logs are used to record all user centered events within a system
- No piece of data should be modified without the admins being able to identify that user
- If people are trying to log into a system and keep failing
	- There should be a record of it

### Logging and auditing

- Auditing is not just about finger pointing when things go wrong
- It can be used to check that data is reliable and up to date
- That workers are actually working
	- A contentious issue in modern workplaces
- That incorrectly added/deleted/edited data can be identified and corrected
- That possible security issues can be identified and dealt with
- To indicate when a system is at max/min load
	- So maintenance/backup can be planned for with minimum disruption

### Auditing issues

- Who does the auditing
	- Can users see own logs
	- Can only admins see all logs
	- Do they need a specific reason to review user event logs
	- Is privacy an issue
- Auditing polcy
	- Should staff know what is being audited
	- How long are audit records kept
	- Do audit records provide absolute proof of the events that took place
- As potential developers
	- These are just some of the issues you will need to be aware of when developing
- Not all these questions have easy answers
- An application with no auditing is like a bank without locks or cameras
- However
	- While auditing can be a critical problem resolution
	- It creates problems of
		- Access
		- Privileges
		- System capacity
		- System performance

## Conclusion

- Session management is a crucial skill to master in any web dev environment
- For multipage/level user applications
	- They are essential
- Sessions are also crucial to
	- Security
	- User management
	- Site usage analysis
